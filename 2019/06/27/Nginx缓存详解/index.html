<!-- build time:Tue Aug 10 2021 20:35:35 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="google-site-verification" content="meY19x4ZHP3_DDZwmuVj0400BZy2zVv4lSeZLIHDdE"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Nginx缓存详解 | weeweetan</title><meta name="description" content="1. 相关配置1.1 配置指令Nginx缓存由proxy_cache_path指令开启1proxy_cache_path D:\output levels=1:2 keys_zone=my_cache:10m max_size=2g inactive=60m use_temp_path=off;对于每个参数的具体含义可以参考nginx官方文档，对于缓存文件名则需要proxy_cache_key指令"><meta name="keywords" content="Nginx"><meta property="og:type" content="article"><meta property="og:title" content="Nginx缓存详解"><meta property="og:url" content="https://weeweetan.github.io/2019/06/27/Nginx缓存详解/index.html"><meta property="og:site_name" content="weeweetan&#39;s blog"><meta property="og:description" content="1. 相关配置1.1 配置指令Nginx缓存由proxy_cache_path指令开启1proxy_cache_path D:\output levels=1:2 keys_zone=my_cache:10m max_size=2g inactive=60m use_temp_path=off;对于每个参数的具体含义可以参考nginx官方文档，对于缓存文件名则需要proxy_cache_key指令"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2021-06-03T14:50:11.072Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nginx缓存详解"><meta name="twitter:description" content="1. 相关配置1.1 配置指令Nginx缓存由proxy_cache_path指令开启1proxy_cache_path D:\output levels=1:2 keys_zone=my_cache:10m max_size=2g inactive=60m use_temp_path=off;对于每个参数的具体含义可以参考nginx官方文档，对于缓存文件名则需要proxy_cache_key指令"><link rel="canonical" href="https://weeweetan.github.io/2019/06/27/Nginx缓存详解/index.html"><link rel="alternate" href="/atom.xml" title="weeweetan&#39;s blog" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/weeweetan" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">weeweetan</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Backend Developer</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Chengdu, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-books"><a href="/books"><i class="icon icon-book-fill"></i> <span class="menu-title">书单</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/weeweetan" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.com" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p style="color:red">声明：本站文章仅代表作者个人观点，与作者所在公司无关。</p><br>欢迎交流与分享经验!</div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/FFmpeg/">FFmpeg</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GLib/">GLib</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socket/">Socket</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/VMware-vSphere/">VMware-vSphere</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/libxml/">libxml</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/总结/">总结</a><span class="category-list-count">9</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dos/">Dos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFmpeg/">FFmpeg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GDB/">GDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GLib/">GLib</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/">Laravel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socket/">Socket</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VMware-vSphere/">VMware-vSphere</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libxml/">libxml</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vddk/">vddk</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vxlan/">vxlan</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/翻译/">翻译</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/驱动模块/">驱动模块</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/C/" style="font-size:13px">C</a> <a href="/tags/Dos/" style="font-size:13px">Dos</a> <a href="/tags/FFmpeg/" style="font-size:13px">FFmpeg</a> <a href="/tags/GDB/" style="font-size:13px">GDB</a> <a href="/tags/GLib/" style="font-size:13.25px">GLib</a> <a href="/tags/Java/" style="font-size:13px">Java</a> <a href="/tags/Laravel/" style="font-size:13px">Laravel</a> <a href="/tags/Linux/" style="font-size:13.25px">Linux</a> <a href="/tags/MySQL/" style="font-size:13px">MySQL</a> <a href="/tags/Nginx/" style="font-size:14px">Nginx</a> <a href="/tags/PHP/" style="font-size:13.5px">PHP</a> <a href="/tags/Socket/" style="font-size:13.25px">Socket</a> <a href="/tags/VMware-vSphere/" style="font-size:13.75px">VMware-vSphere</a> <a href="/tags/libxml/" style="font-size:13px">libxml</a> <a href="/tags/vddk/" style="font-size:13px">vddk</a> <a href="/tags/vxlan/" style="font-size:13px">vxlan</a> <a href="/tags/翻译/" style="font-size:13px">翻译</a> <a href="/tags/驱动模块/" style="font-size:13px">驱动模块</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Nginx/">Nginx</a></p><p class="item-title"><a href="/2021/05/09/Nginx的http-core模块/" class="title">Nginx的http_core模块</a></p><p class="item-date"><time datetime="2021-05-09T13:06:24.000Z" itemprop="datePublished">2021-05-09</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/04/10/vxlan学习笔记/" class="title">vxlan学习笔记</a></p><p class="item-date"><time datetime="2021-04-10T14:05:41.000Z" itemprop="datePublished">2021-04-10</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/FFmpeg/">FFmpeg</a></p><p class="item-title"><a href="/2020/11/14/FFmpeg学习笔记/" class="title">FFmpeg学习笔记</a></p><p class="item-date"><time datetime="2020-11-14T09:37:03.000Z" itemprop="datePublished">2020-11-14</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Nginx/">Nginx</a></p><p class="item-title"><a href="/2020/05/25/Nginx的共享内存详解/" class="title">Nginx的共享内存详解</a></p><p class="item-date"><time datetime="2020-05-25T12:05:11.000Z" itemprop="datePublished">2020-05-25</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Nginx/">Nginx</a></p><p class="item-title"><a href="/2020/04/15/Nginx限流模块详解/" class="title">Nginx限流模块详解</a></p><p class="item-date"><time datetime="2020-04-15T14:54:37.000Z" itemprop="datePublished">2020-04-15</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-相关配置"><span class="toc-number">1.</span> <span class="toc-text">1. 相关配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-配置指令"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 配置指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-源码解析"><span class="toc-number">2.</span> <span class="toc-text">2. 源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-关键结构体"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 关键结构体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-生成标记缓存文件的key"><span class="toc-number">3.</span> <span class="toc-text">2.2 生成标记缓存文件的key</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-缓存文件名生成"><span class="toc-number">3.1.</span> <span class="toc-text">2.3 缓存文件名生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-生成由levels参数指定的目录层级"><span class="toc-number">3.2.</span> <span class="toc-text">2.4 生成由levels参数指定的目录层级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-从红黑树中查找缓存节点"><span class="toc-number">3.3.</span> <span class="toc-text">2.5 从红黑树中查找缓存节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-打开缓存文件"><span class="toc-number">3.4.</span> <span class="toc-text">2.6 打开缓存文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-读缓存文件"><span class="toc-number">3.5.</span> <span class="toc-text">2.7 读缓存文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-发送缓存"><span class="toc-number">3.6.</span> <span class="toc-text">2.8 发送缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-向上游回源"><span class="toc-number">3.7.</span> <span class="toc-text">2.9 向上游回源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-接受上游返回的数据"><span class="toc-number">3.8.</span> <span class="toc-text">2.10 接受上游返回的数据</span></a></li></ol></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-Nginx缓存详解" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Nginx缓存详解</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2019/06/27/Nginx缓存详解/" class="article-date"><time datetime="2019-06-27T12:56:57.000Z" itemprop="datePublished">2019-06-27</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/Nginx/">Nginx</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/Nginx/">Nginx</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2019/06/27/Nginx缓存详解/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 7k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 37(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h2 id="1-相关配置"><a href="#1-相关配置" class="headerlink" title="1. 相关配置"></a>1. 相关配置</h2><h3 id="1-1-配置指令"><a href="#1-1-配置指令" class="headerlink" title="1.1 配置指令"></a>1.1 配置指令</h3><blockquote><p>Nginx缓存由<strong>proxy_cache_path</strong>指令开启</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_path D:\output levels=1:2 keys_zone=my_cache:10m max_size=2g inactive=60m use_temp_path=off;</span><br></pre></td></tr></table></figure><blockquote><p>对于每个参数的具体含义可以参考<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path" target="_blank" rel="noopener">nginx官方文档</a>，对于缓存文件名则需要proxy_cache_key指令指定</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache my_cache;</span><br></pre></td></tr></table></figure><blockquote><p>对于该指令的具体用法可以参考<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache" target="_blank" rel="noopener">nginx官方文档</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_valid 200 1h;</span><br></pre></td></tr></table></figure><blockquote><p><strong>需要注意的是，如果没有这条指令，nginx将不会缓存上游的数据</strong>。对于该指令的具体用法可以参考<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_valid" target="_blank" rel="noopener">nginx官方文档</a></p></blockquote><h2 id="2-源码解析"><a href="#2-源码解析" class="headerlink" title="2. 源码解析"></a>2. 源码解析</h2><blockquote><p>Nginx与文件缓存相关的代码在<strong>src/http/ngx_http_file_cache.c</strong></p></blockquote><h3 id="2-1-关键结构体"><a href="#2-1-关键结构体" class="headerlink" title="2.1 关键结构体"></a>2.1 关键结构体</h3><blockquote><p>与缓存相关的结构体有<em>ngx_path_t</em>、<em>ngx_http_file_cache_sh_t</em>、<em>ngx_http_file_cache_s</em> 、<em>ngx_http_file_cache_node_t</em>、 <em>ngx_http_file_cache_header_t</em>，来看看这几个结构体的定义</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                  name;</span><br><span class="line">    <span class="keyword">size_t</span>                     len;</span><br><span class="line">    <span class="keyword">size_t</span>                     level[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    ngx_path_manager_pt        manager;  <span class="comment">//决定是否启用cache manager进程 </span></span><br><span class="line">    ngx_path_loader_pt         loader;  <span class="comment">//决定是否启用cache loader进程 </span></span><br><span class="line">    <span class="keyword">void</span>                      *data;</span><br><span class="line"></span><br><span class="line">    u_char                    *conf_file;   <span class="comment">//nginx配置文件路径</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 line;</span><br><span class="line">&#125; <span class="keyword">ngx_path_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_t</span>                     rbtree;  </span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>                sentinel;</span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                      <span class="built_in">queue</span>;</span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>                     cold;</span><br><span class="line">    <span class="keyword">ngx_atomic_t</span>                     loading;</span><br><span class="line">    <span class="keyword">off_t</span>                            size;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       count;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       watermark;</span><br><span class="line">&#125; <span class="keyword">ngx_http_file_cache_sh_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_file_cache_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_http_file_cache_sh_t</span>        *sh;</span><br><span class="line">    <span class="keyword">ngx_slab_pool_t</span>                 *shpool;      <span class="comment">/* shpool是用于管理共享内存的 slab allocator ，所有缓存节点占用空间都由它进行分配 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_path_t</span>                      *path;             <span class="comment">/* ngx_http_file_cache_set_slot中创建ngx_path_t空间 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">off_t</span>                            max_size;      <span class="comment">//缓存目录能保存的缓存最大值</span></span><br><span class="line">    <span class="keyword">size_t</span>                           bsize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">time_t</span>                           inactive;     <span class="comment">/* 触发LRU算法阈值 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">time_t</span>                           fail_time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       files;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       loader_files;  <span class="comment">/* 阈值，当load的文件个数大于这个值之后，load进程会短暂的休眠(时间位loader_sleep) */</span></span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       last;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       loader_sleep;  <span class="comment">/* 阈值，执行一次缓存文件加载到共享内存后 , 进程的休眠时间 , 默认200 */</span></span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       loader_threshold;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       manager_files;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       manager_sleep; <span class="comment">/* 阈值，处理一定数量缓存结点后, 进程的休眠时间 , 默认200 */</span></span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       manager_threshold;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_shm_zone_t</span>                  *shm_zone;      <span class="comment">/* 共享内存区 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       use_temp_path; <span class="comment">/* 是否使用临时目录 */</span></span><br><span class="line">                                     <span class="comment">/* unsigned use_temp_path:1 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>                node;     <span class="comment">/* 缓存查询树的节点 */</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>                      <span class="built_in">queue</span>;     <span class="comment">/* LRU页面置换算法 队列中的节点 */</span></span><br><span class="line"></span><br><span class="line">    u_char                           key[NGX_HTTP_CACHE_KEY_LEN</span><br><span class="line">                                         - <span class="keyword">sizeof</span>(<span class="keyword">ngx_rbtree_key_t</span>)];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                         count:<span class="number">20</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         uses:<span class="number">10</span>;           <span class="comment">//缓存使用次数</span></span><br><span class="line">    <span class="keyword">unsigned</span>                         valid_msec:<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         error:<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         exists:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         updating:<span class="number">1</span>;        <span class="comment">// 缓存分片更新标志位</span></span><br><span class="line">    <span class="keyword">unsigned</span>                         deleting:<span class="number">1</span>;        <span class="comment">// 缓存分片删除标志位</span></span><br><span class="line">    <span class="keyword">unsigned</span>                         purged:<span class="number">1</span>;</span><br><span class="line">                                     <span class="comment">/* 10 unused bits */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_file_uniq_t</span>                  uniq;</span><br><span class="line">    <span class="keyword">time_t</span>                           expire;            <span class="comment">//过期时间</span></span><br><span class="line">    <span class="keyword">time_t</span>                           valid_sec;</span><br><span class="line">    <span class="keyword">size_t</span>                           body_start;</span><br><span class="line">    <span class="keyword">off_t</span>                            fs_size;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       lock_time;</span><br><span class="line">&#125; <span class="keyword">ngx_http_file_cache_node_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在写缓存文件时会将这个结构体写入</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       version;</span><br><span class="line">    <span class="keyword">time_t</span>                           valid_sec;</span><br><span class="line">    <span class="keyword">time_t</span>                           updating_sec;</span><br><span class="line">    <span class="keyword">time_t</span>                           error_sec;</span><br><span class="line">    <span class="keyword">time_t</span>                           last_modified;</span><br><span class="line">    <span class="keyword">time_t</span>                           date;</span><br><span class="line">    <span class="keyword">uint32_t</span>                         crc32;</span><br><span class="line">    u_short                          valid_msec;</span><br><span class="line">    u_short                          header_start;         <span class="comment">/* 缓存文件中http头开始的偏移 */</span></span><br><span class="line">    u_short                          body_start;</span><br><span class="line">    u_char                           etag_len;</span><br><span class="line">    u_char                           etag[NGX_HTTP_CACHE_ETAG_LEN];</span><br><span class="line">    u_char                           vary_len;</span><br><span class="line">    u_char                           vary[NGX_HTTP_CACHE_VARY_LEN];</span><br><span class="line">    u_char                           variant[NGX_HTTP_CACHE_KEY_LEN];</span><br><span class="line">&#125; <span class="keyword">ngx_http_file_cache_header_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_cache_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_file_t</span>                       file;    <span class="comment">/* 缓存文件描述结构体 */</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>                      keys;    <span class="comment">/* 存放proxy_cache_key指令的值 */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>                         crc32;</span><br><span class="line">    u_char                           key[NGX_HTTP_CACHE_KEY_LEN];     <span class="comment">/* 存放计算md5后的值 */</span></span><br><span class="line">    u_char                           main[NGX_HTTP_CACHE_KEY_LEN];    <span class="comment">/* 跟key相同 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_file_uniq_t</span>                  uniq;</span><br><span class="line">    <span class="keyword">time_t</span>                           valid_sec;</span><br><span class="line">    <span class="keyword">time_t</span>                           updating_sec;</span><br><span class="line">    <span class="keyword">time_t</span>                           error_sec;</span><br><span class="line">    <span class="keyword">time_t</span>                           last_modified;</span><br><span class="line">    <span class="keyword">time_t</span>                           date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                        etag;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                        vary;</span><br><span class="line">    u_char                           variant[NGX_HTTP_CACHE_KEY_LEN];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span>                           header_start;     <span class="comment">/* http头在缓存中的偏移位置 */</span></span><br><span class="line">    <span class="keyword">size_t</span>                           body_start;       <span class="comment">/* http响应体在缓存中的偏移位置 */</span></span><br><span class="line">    <span class="keyword">off_t</span>                            length;           <span class="comment">/* 缓存文件的大小，见ngx_http_file_cache_open */</span></span><br><span class="line">    <span class="keyword">off_t</span>                            fs_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       min_uses;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       error;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       valid_msec;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                       vary_tag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                       *buf;      <span class="comment">/* 存储缓存文件头 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_file_cache_t</span>           *file_cache;</span><br><span class="line">    <span class="keyword">ngx_http_file_cache_node_t</span>      *node;      <span class="comment">//ngx_http_file_cache_exists中创建空间和赋值</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_THREADS || NGX_COMPAT)</span></span><br><span class="line">    <span class="keyword">ngx_thread_task_t</span>               *thread_task;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       lock_timeout;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       lock_age;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       lock_time;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                       wait_time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_event_t</span>                      wait_event;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                         lock:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         waiting:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                         updated:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         updating:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         exists:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         temp_file:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         purged:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         reading:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         secondary:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         background:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                         stale_updating:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                         stale_error:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>部分字段含义见注释</p></blockquote><h2 id="2-2-生成标记缓存文件的key"><a href="#2-2-生成标记缓存文件的key" class="headerlink" title="2.2 生成标记缓存文件的key"></a>2.2 生成标记缓存文件的key</h2><blockquote><p>生成标记缓存文件的key由<em>ngx_http_file_cache_create_key</em>函数实现，我们来看看具体实现</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_http_file_cache_create_key(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>             len;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>         *key;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_md5_t</span>          md5;</span><br><span class="line">    <span class="keyword">ngx_http_cache_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;cache;</span><br><span class="line"></span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ngx_crc32_init(c-&gt;crc32);</span><br><span class="line">    ngx_md5_init(&amp;md5);</span><br><span class="line"></span><br><span class="line">    key = c-&gt;keys.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c-&gt;keys.nelts; i++) &#123;</span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http cache key: \"%V\""</span>, &amp;key[i]);</span><br><span class="line"></span><br><span class="line">        len += key[i].len;</span><br><span class="line"></span><br><span class="line">        ngx_crc32_update(&amp;c-&gt;crc32, key[i].data, key[i].len);</span><br><span class="line">        ngx_md5_update(&amp;md5, key[i].data, key[i].len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;header_start = <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_file_cache_header_t</span>)</span><br><span class="line">                      + <span class="keyword">sizeof</span>(ngx_http_file_cache_key) + len + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ngx_crc32_final(c-&gt;crc32);</span><br><span class="line">    ngx_md5_final(c-&gt;key, &amp;md5);</span><br><span class="line"></span><br><span class="line">    ngx_memcpy(c-&gt;main, c-&gt;key, NGX_HTTP_CACHE_KEY_LEN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>该函数实现较简单，主要是计算proxy_cache_key指令值的md5值，并保存，然后初始化header_start成员的值，这个地方需要注意一下缓存文件头部信息<br>[ngx_http_file_cache_header_t][“\nKEY: “][orig_key][“\n”][header][body]</p></blockquote><h3 id="2-3-缓存文件名生成"><a href="#2-3-缓存文件名生成" class="headerlink" title="2.3 缓存文件名生成"></a>2.3 缓存文件名生成</h3><blockquote><p>生成缓存文件名主要由<em>ngx_http_file_cache_name</em>实现，现在来看看源码</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_file_cache_name(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_path_t</span> *path)</span><br><span class="line">&#123;</span><br><span class="line">    u_char            *p;</span><br><span class="line">    <span class="keyword">ngx_http_cache_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;file.name.len) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;file.name.len = path-&gt;name.len + <span class="number">1</span> + path-&gt;len</span><br><span class="line">                       + <span class="number">2</span> * NGX_HTTP_CACHE_KEY_LEN;</span><br><span class="line"></span><br><span class="line">    c-&gt;file.name.data = ngx_pnalloc(r-&gt;pool, c-&gt;file.name.len + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;file.name.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memcpy(c-&gt;file.name.data, path-&gt;name.data, path-&gt;name.len);</span><br><span class="line"></span><br><span class="line">    p = c-&gt;file.name.data + path-&gt;name.len + <span class="number">1</span> + path-&gt;len;</span><br><span class="line">    p = ngx_hex_dump(p, c-&gt;key, NGX_HTTP_CACHE_KEY_LEN);</span><br><span class="line">    *p = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    ngx_create_hashed_filename(path, c-&gt;file.name.data, c-&gt;file.name.len);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"cache file: \"%s\""</span>, c-&gt;file.name.data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><ol><li>该函数首先判断当前缓存文件名是否已经生成成功，若已生成，则直接返回，代码如下：</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (c-&gt;file.name.len) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>接下来计算缓存文件名长度，其中<em>path-&gt;name.len</em>为<em>proxy_cache_path</em>指令第一个参数，path-&gt;len为levels长度，比如level=1:2则path-&gt;len为5，包含两个/，代码如下：</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c-&gt;file.name.len = path-&gt;name.len + <span class="number">1</span> + path-&gt;len</span><br><span class="line">                   + <span class="number">2</span> * NGX_HTTP_CACHE_KEY_LEN;</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>接着为缓存文件名申请内存，代码如下：</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c-&gt;file.name.data = ngx_pnalloc(r-&gt;pool, c-&gt;file.name.len + <span class="number">1</span>);</span><br></pre></td></tr></table></figure><blockquote><ol start="4"><li>接着将<em>proxy_cache_path</em>指令设置的路径复制到<em>c-&gt;file.name.data</em>最前端，完成后<em>c-&gt;file.name.data</em>的值为:D:\output,代码如下：</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_memcpy(c-&gt;file.name.data, path-&gt;name.data, path-&gt;name.len);</span><br></pre></td></tr></table></figure><blockquote><ol start="5"><li>接着将p指向<em>c-&gt;file.name.data</em>偏移 <em>path-&gt;name.len + 1 + path-&gt;len</em>的位置处，这样做的目的是准备生成32位长的md5文件名，并预留level设置的目录</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p = c-&gt;file.name.data + path-&gt;name.len + <span class="number">1</span> + path-&gt;len;</span><br><span class="line">p = ngx_hex_dump(p, c-&gt;key, NGX_HTTP_CACHE_KEY_LEN);</span><br><span class="line">*p = <span class="string">'\0'</span>;</span><br></pre></td></tr></table></figure><blockquote><p>这一步完成之后<em>c-&gt;file.name.data</em>的值为D:\output屯屯屯md5(proxy_cache_key)</p></blockquote><blockquote><ol start="6"><li>调用<em>ngx_create_hashed_filename</em>函数补全第5步预留的level目录</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_create_hashed_filename(path, c-&gt;file.name.data, c-&gt;file.name.len);</span><br></pre></td></tr></table></figure><h3 id="2-4-生成由levels参数指定的目录层级"><a href="#2-4-生成由levels参数指定的目录层级" class="headerlink" title="2.4 生成由levels参数指定的目录层级"></a>2.4 生成由levels参数指定的目录层级</h3><blockquote><p>生成由levels参数指定的目录层级由<em>ngx_create_hashed_filename</em>实现，现在来看看源码</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ngx_create_hashed_filename(<span class="keyword">ngx_path_t</span> *path, u_char *file, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span>      i, level;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>  n;</span><br><span class="line"></span><br><span class="line">    i = path-&gt;name.len + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    file[path-&gt;name.len + path-&gt;len]  = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; NGX_MAX_PATH_LEVEL; n++) &#123;</span><br><span class="line">        level = path-&gt;level[n];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (level == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len -= level;</span><br><span class="line">        file[i - <span class="number">1</span>] = <span class="string">'/'</span>;</span><br><span class="line">        ngx_memcpy(&amp;file[i], &amp;file[len], level);</span><br><span class="line">        i += level + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol><li>从上一节中我们知道参数file的值为D:\output屯屯屯md5(proxy_cache_key)，该函数首先用一个变量i保存path长度加1，这个设计非常巧妙，在后续中会使用到，代码如下：</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = path-&gt;name.len + <span class="number">1</span>;</span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>接着修改file的值，在层级目录后添加一个反斜杠，修改后为D:\output屯屯屯/md5(proxy_cache_key)</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file[path-&gt;name.len + path-&gt;len]  = <span class="string">'/'</span>;</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>接下来进入一个for循环，填充file中的屯屯屯，在第一次循环中首先获取levels=1：2中的1，接着用变量len减去变量level，接着在output后添加一个’/‘，然后将file中从len位置复制1个字符到<em>output/</em>后，修改i的值；第二次循环，首先获取levels=1：2中的2，接着用len减去2，接着在第一次缓存复制的字符后添加一个’/‘，然后把file从len处复制2个字符到上一步的’/‘后，修改i的值；第三次跳出循环，至此填充完成，代码如下：</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; NGX_MAX_PATH_LEVEL; n++) &#123;</span><br><span class="line">    level = path-&gt;level[n];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (level == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len -= level;</span><br><span class="line">    file[i - <span class="number">1</span>] = <span class="string">'/'</span>;</span><br><span class="line">    ngx_memcpy(&amp;file[i], &amp;file[len], level);</span><br><span class="line">    i += level + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-从红黑树中查找缓存节点"><a href="#2-5-从红黑树中查找缓存节点" class="headerlink" title="2.5 从红黑树中查找缓存节点"></a>2.5 从红黑树中查找缓存节点</h3><blockquote><p>缓存key跟缓存文件名生成好之后，紧接着根据生成好的key从红黑树中查找，若不存在则插入，找到则返回对应的缓存节点，这个功能由<em>ngx_http_file_cache_exists</em>函数实现，我们看看具体实现。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">static ngx_int_t</span><br><span class="line">ngx_http_file_cache_exists(ngx_http_file_cache_t *cache, ngx_http_cache_t *c)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_int_t                    rc;</span><br><span class="line">    ngx_http_file_cache_node_t  *fcn;</span><br><span class="line"></span><br><span class="line">    ngx_shmtx_lock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">    fcn = c-&gt;node;//后面没找到则会创建node节点</span><br><span class="line">   </span><br><span class="line">    if (fcn == NULL) &#123;</span><br><span class="line">        fcn = ngx_http_file_cache_lookup(cache, c-&gt;key); //以 c-&gt;key 为查找条件从缓存中查找缓存节点： </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (fcn) &#123; //cache中存在该key</span><br><span class="line">        ngx_queue_remove(&amp;fcn-&gt;queue);</span><br><span class="line"></span><br><span class="line">        //该客户端在新建连接后，如果之前有缓存该文件，则c-&gt;node为NULL，表示这个连接请求第一次走到这里，有一个客户端在获取数据，如果在</span><br><span class="line">        //连接范围内(还没有断开连接)多次获取该缓存文件，则也只会加1，表示当前有多少个客户端连接在获取该缓存</span><br><span class="line">        if (c-&gt;node == NULL) &#123; //如果该请求第一次使用此缓存节点，则增加相关引用和使用次数</span><br><span class="line">            fcn-&gt;uses++;</span><br><span class="line">            fcn-&gt;count++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (fcn-&gt;error) &#123;</span><br><span class="line"></span><br><span class="line">            if (fcn-&gt;valid_sec &lt; ngx_time()) &#123;</span><br><span class="line">                goto renew; //缓存已过期</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rc = NGX_OK;</span><br><span class="line"></span><br><span class="line">            goto done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (fcn-&gt;exists || fcn-&gt;uses &gt;= c-&gt;min_uses) &#123; //该请求的缓存已经存在，并且对该缓存的请求次数达到了最低要求次数min_uses</span><br><span class="line">            //表示该缓存文件是否存在，Proxy_cache_min_uses 3，则第3次后开始获取后端数据，获取完毕后在ngx_http_file_cache_update中置1，但是只有在地4次请求的时候才会在ngx_http_file_cache_exists赋值为1</span><br><span class="line">            c-&gt;exists = fcn-&gt;exists;</span><br><span class="line">            if (fcn-&gt;body_start) &#123;</span><br><span class="line">                c-&gt;body_start = fcn-&gt;body_start;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rc = NGX_OK;</span><br><span class="line"></span><br><span class="line">            goto done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //例如配置Proxy_cache_min_uses 5，则需要客户端请求5才才能从缓存中取，如果现在只有4次，则都需要从后端获取数据</span><br><span class="line">        rc = NGX_AGAIN;</span><br><span class="line"></span><br><span class="line">        goto done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //没找到，则在下面创建node节点，添加到ngx_http_file_cache_t-&gt;sh-&gt;rbtree红黑树中</span><br><span class="line">    fcn = ngx_slab_calloc_locked(cache-&gt;shpool,</span><br><span class="line">                                 sizeof(ngx_http_file_cache_node_t));</span><br><span class="line">    if (fcn == NULL) &#123;</span><br><span class="line">        ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">        (void) ngx_http_file_cache_forced_expire(cache);</span><br><span class="line"></span><br><span class="line">        ngx_shmtx_lock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">        fcn = ngx_slab_calloc_locked(cache-&gt;shpool,</span><br><span class="line">                                     sizeof(ngx_http_file_cache_node_t));</span><br><span class="line">        if (fcn == NULL) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;log, 0,</span><br><span class="line">                          &quot;could not allocate node%s&quot;, cache-&gt;shpool-&gt;log_ctx);</span><br><span class="line">            rc = NGX_ERROR;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memcpy((u_char *) &amp;fcn-&gt;node.key, c-&gt;key, sizeof(ngx_rbtree_key_t));</span><br><span class="line"></span><br><span class="line">    ngx_memcpy(fcn-&gt;key, &amp;c-&gt;key[sizeof(ngx_rbtree_key_t)],</span><br><span class="line">               NGX_HTTP_CACHE_KEY_LEN - sizeof(ngx_rbtree_key_t));</span><br><span class="line"></span><br><span class="line">    ngx_rbtree_insert(&amp;cache-&gt;sh-&gt;rbtree, &amp;fcn-&gt;node); //把该节点添加到红黑树中</span><br><span class="line"></span><br><span class="line">    fcn-&gt;uses = 1;</span><br><span class="line">    fcn-&gt;count = 1;</span><br><span class="line"></span><br><span class="line">renew:</span><br><span class="line"></span><br><span class="line">    rc = NGX_DECLINED; //uri第一次请求的时候创建node节点，同时返回NGX_DECLINED。或者缓存过期需要把该节点相关信息恢复为默认值</span><br><span class="line"></span><br><span class="line">    fcn-&gt;valid_msec = 0;</span><br><span class="line">    fcn-&gt;error = 0;</span><br><span class="line">    fcn-&gt;exists = 0;</span><br><span class="line">    fcn-&gt;valid_sec = 0;</span><br><span class="line">    fcn-&gt;uniq = 0;</span><br><span class="line">    fcn-&gt;body_start = 0;</span><br><span class="line">    fcn-&gt;fs_size = 0;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line"></span><br><span class="line">    fcn-&gt;expire = ngx_time() + cache-&gt;inactive;</span><br><span class="line"></span><br><span class="line">    ngx_queue_insert_head(&amp;cache-&gt;sh-&gt;queue, &amp;fcn-&gt;queue); //新创建的node节点添加到cache-&gt;sh-&gt;queue头部</span><br><span class="line"></span><br><span class="line">    c-&gt;uniq = fcn-&gt;uniq;//文件的uniq  赋值见ngx_http_file_cache_update</span><br><span class="line">    c-&gt;error = fcn-&gt;error;</span><br><span class="line">    c-&gt;node = fcn; //把新创建的fcn赋值给c-&gt;node</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">    ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">    return rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-6-打开缓存文件"><a href="#2-6-打开缓存文件" class="headerlink" title="2.6 打开缓存文件"></a>2.6 打开缓存文件</h3><blockquote><p>上一节中介绍了如何从红黑树中查找缓存节点，找到缓存节点之后，就要需要根据缓存节点中的缓存文件路径去打开缓存文件了，Nginx使用<em>ngx_http_file_cache_open</em>函数实现，接下来我们来看看实现：</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_file_cache_open(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc, rv;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 test;</span><br><span class="line">    <span class="keyword">ngx_http_cache_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_pool_cleanup_t</span>        *cln;</span><br><span class="line">    <span class="keyword">ngx_open_file_info_t</span>       of;</span><br><span class="line">    <span class="keyword">ngx_http_file_cache_t</span>     *cache;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;waiting) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;reading) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_file_cache_read(r, c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cache = c-&gt;file_cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        cln = ngx_pool_cleanup_add(r-&gt;pool, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (cln == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cln-&gt;handler = ngx_http_file_cache_cleanup;</span><br><span class="line">        cln-&gt;data = c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = ngx_http_file_cache_exists(cache, c);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http file cache exists: %i e:%d"</span>, rc, c-&gt;exists);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_CACHE_SCARCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;error) &#123;</span><br><span class="line">            <span class="keyword">return</span> c-&gt;error;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        c-&gt;temp_file = <span class="number">1</span>;</span><br><span class="line">        test = c-&gt;exists ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        rv = NGX_DECLINED;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">/* rc == NGX_DECLINED */</span></span><br><span class="line"></span><br><span class="line">        test = cache-&gt;sh-&gt;cold ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;min_uses &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!test) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_CACHE_SCARCE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rv = NGX_HTTP_CACHE_SCARCE;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            c-&gt;temp_file = <span class="number">1</span>;</span><br><span class="line">            rv = NGX_DECLINED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_file_cache_name(r, cache-&gt;path) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!test) &#123;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;of, <span class="keyword">sizeof</span>(<span class="keyword">ngx_open_file_info_t</span>));</span><br><span class="line"></span><br><span class="line">    of.uniq = c-&gt;uniq;</span><br><span class="line">    of.valid = clcf-&gt;open_file_cache_valid;</span><br><span class="line">    of.min_uses = clcf-&gt;open_file_cache_min_uses;</span><br><span class="line">    of.events = clcf-&gt;open_file_cache_events;</span><br><span class="line">    of.directio = NGX_OPEN_FILE_DIRECTIO_OFF;</span><br><span class="line">    of.read_ahead = clcf-&gt;read_ahead;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_open_cached_file(clcf-&gt;open_file_cache, &amp;c-&gt;file.name, &amp;of, r-&gt;pool)</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (of.err) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> NGX_ENOENT:</span><br><span class="line">        <span class="keyword">case</span> NGX_ENOTDIR:</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;<span class="built_in">log</span>, of.err,</span><br><span class="line">                          ngx_open_file_n <span class="string">" \"%s\" failed"</span>, c-&gt;file.name.data);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http file cache fd: %d"</span>, of.fd);</span><br><span class="line"></span><br><span class="line">    c-&gt;file.fd = of.fd;</span><br><span class="line">    c-&gt;file.<span class="built_in">log</span> = r-&gt;connection-&gt;<span class="built_in">log</span>;</span><br><span class="line">    c-&gt;uniq = of.uniq;</span><br><span class="line">    c-&gt;length = of.size;</span><br><span class="line">    c-&gt;fs_size = (of.fs_size + cache-&gt;bsize - <span class="number">1</span>) / cache-&gt;bsize;</span><br><span class="line"></span><br><span class="line">    c-&gt;buf = ngx_create_temp_buf(r-&gt;pool, c-&gt;body_start);</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ngx_http_file_cache_read(r, c);</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rv == NGX_DECLINED) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_file_cache_lock(r, c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-7-读缓存文件"><a href="#2-7-读缓存文件" class="headerlink" title="2.7 读缓存文件"></a>2.7 读缓存文件</h3><blockquote><p>若缓存文件存在，则会读取缓存文件头部，并根据读取出的头部信息进行下一步操作，nginx使用<em>ngx_http_file_cache_read</em>函数实现这个功能，我们来看一下具体实现</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_file_cache_read(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_cache_t</span> *c)</span><br><span class="line">&#123;</span><br><span class="line">    u_char                        *p;</span><br><span class="line">    <span class="keyword">time_t</span>                         now;</span><br><span class="line">    <span class="keyword">ssize_t</span>                        n;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                     *key;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                      rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                     i;</span><br><span class="line">    <span class="keyword">ngx_http_file_cache_t</span>         *cache;</span><br><span class="line">    <span class="keyword">ngx_http_file_cache_header_t</span>  *h;</span><br><span class="line"></span><br><span class="line">    n = ngx_http_file_cache_aio_read(r, c);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//写缓冲区封装过程参考:ngx_http_upstream_process_header</span></span><br><span class="line">     <span class="comment">//缓存文件中前面部分格式:[ngx_http_file_cache_header_t]["\nKEY: "][orig_key]["\n"][header]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">size_t</span>) n &lt; c-&gt;header_start) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"cache file \"%s\" is too small"</span>, c-&gt;file.name.data);</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h = (<span class="keyword">ngx_http_file_cache_header_t</span> *) c-&gt;buf-&gt;pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (h-&gt;version != NGX_HTTP_CACHE_VERSION) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"cache file \"%s\" version mismatch"</span>, c-&gt;file.name.data);</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;   <span class="comment">//如果返回这个NGX_DECLINED，会把cached置0，返回出去后只有从后端从新获取数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (h-&gt;crc32 != c-&gt;crc32 || (<span class="keyword">size_t</span>) h-&gt;header_start != c-&gt;header_start) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"cache file \"%s\" has md5 collision"</span>, c-&gt;file.name.data);</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = c-&gt;buf-&gt;pos + <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_file_cache_header_t</span>)</span><br><span class="line">        + <span class="keyword">sizeof</span>(ngx_http_file_cache_key);</span><br><span class="line"></span><br><span class="line">    key = c-&gt;keys.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c-&gt;keys.nelts; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_memcmp(p, key[i].data, key[i].len) != <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"cache file \"%s\" has md5 collision"</span>,</span><br><span class="line">                          c-&gt;file.name.data);</span><br><span class="line">            <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p += key[i].len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">size_t</span>) h-&gt;body_start &gt; c-&gt;body_start) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"cache file \"%s\" has too long header"</span>,</span><br><span class="line">                      c-&gt;file.name.data);</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (h-&gt;vary_len &gt; NGX_HTTP_CACHE_VARY_LEN) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"cache file \"%s\" has incorrect vary length"</span>,</span><br><span class="line">                      c-&gt;file.name.data);</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (h-&gt;vary_len) &#123;</span><br><span class="line">        ngx_http_file_cache_vary(r, h-&gt;vary, h-&gt;vary_len, c-&gt;variant);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_memcmp(c-&gt;variant, h-&gt;variant, NGX_HTTP_CACHE_KEY_LEN) != <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http file cache vary mismatch"</span>);</span><br><span class="line">            <span class="keyword">return</span> ngx_http_file_cache_reopen(r, c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;buf-&gt;last += n;</span><br><span class="line"></span><br><span class="line">    c-&gt;valid_sec = h-&gt;valid_sec;</span><br><span class="line">    c-&gt;updating_sec = h-&gt;updating_sec;</span><br><span class="line">    c-&gt;error_sec = h-&gt;error_sec;</span><br><span class="line">    c-&gt;last_modified = h-&gt;last_modified;</span><br><span class="line">    c-&gt;date = h-&gt;date;</span><br><span class="line">    c-&gt;valid_msec = h-&gt;valid_msec;</span><br><span class="line">    c-&gt;body_start = h-&gt;body_start;</span><br><span class="line">    c-&gt;etag.len = h-&gt;etag_len;</span><br><span class="line">    c-&gt;etag.data = h-&gt;etag;</span><br><span class="line"></span><br><span class="line">    r-&gt;cached = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    cache = c-&gt;file_cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cache-&gt;sh-&gt;cold) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_shmtx_lock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!c-&gt;node-&gt;exists) &#123;</span><br><span class="line">            c-&gt;node-&gt;uses = <span class="number">1</span>;</span><br><span class="line">            c-&gt;node-&gt;body_start = c-&gt;body_start;</span><br><span class="line">            c-&gt;node-&gt;exists = <span class="number">1</span>;</span><br><span class="line">            c-&gt;node-&gt;uniq = c-&gt;uniq;</span><br><span class="line">            c-&gt;node-&gt;fs_size = c-&gt;fs_size;</span><br><span class="line"></span><br><span class="line">            cache-&gt;sh-&gt;size += c-&gt;fs_size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    now = ngx_time();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;valid_sec &lt; now) &#123;</span><br><span class="line">        c-&gt;stale_updating = c-&gt;valid_sec + c-&gt;updating_sec &gt;= now;</span><br><span class="line">        c-&gt;stale_error = c-&gt;valid_sec + c-&gt;error_sec &gt;= now;</span><br><span class="line"></span><br><span class="line">        ngx_shmtx_lock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;node-&gt;updating) &#123;</span><br><span class="line">            rc = NGX_HTTP_CACHE_UPDATING;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            c-&gt;node-&gt;updating = <span class="number">1</span>;</span><br><span class="line">            c-&gt;updating = <span class="number">1</span>;</span><br><span class="line">            c-&gt;lock_time = c-&gt;node-&gt;lock_time;</span><br><span class="line">            rc = NGX_HTTP_CACHE_STALE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">        ngx_log_debug3(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">"http file cache expired: %i %T %T"</span>,</span><br><span class="line">                       rc, c-&gt;valid_sec, now);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><ol><li>调用ngx_http_file_cache_aio_read函数读取缓存文件，读取大小为c-&gt;header_start，读取完成后，对返回值进行校验，确定是否读取成功，代码如下：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">n = ngx_http_file_cache_aio_read(r, c);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">size_t</span>) n &lt; c-&gt;header_start) &#123;</span><br><span class="line">    ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"cache file \"%s\" is too small"</span>, c-&gt;file.name.data);</span><br><span class="line">    <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol></blockquote><blockquote><ol start="2"><li>取出缓存文件头部，并对其字段进行校验，封包过程参考ngx_http_file_cache_set_header函数<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">h = (<span class="keyword">ngx_http_file_cache_header_t</span> *) c-&gt;buf-&gt;pos;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>使用读出的缓存文件头部，更新内存中缓存节点信息</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">c-&gt;buf-&gt;last += n;    <span class="comment">//buf后续会被用来存放http头，所以这个地方移动last指针</span></span><br><span class="line"></span><br><span class="line">c-&gt;valid_sec = h-&gt;valid_sec;</span><br><span class="line">c-&gt;updating_sec = h-&gt;updating_sec;</span><br><span class="line">c-&gt;error_sec = h-&gt;error_sec;</span><br><span class="line">c-&gt;last_modified = h-&gt;last_modified;</span><br><span class="line">c-&gt;date = h-&gt;date;</span><br><span class="line">c-&gt;valid_msec = h-&gt;valid_msec;</span><br><span class="line">c-&gt;body_start = h-&gt;body_start;</span><br><span class="line">c-&gt;etag.len = h-&gt;etag_len;</span><br><span class="line">c-&gt;etag.data = h-&gt;etag;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-8-发送缓存"><a href="#2-8-发送缓存" class="headerlink" title="2.8 发送缓存"></a>2.8 发送缓存</h3><blockquote><p>若2.7节读取缓存文件成功，而且缓存校验也成功，则开始发送缓存内容，该功能由<em>ngx_http_upstream_cache_send</em>函数实现，接下来我们看看源码</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_upstream_cache_send(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_upstream_t</span> *u)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>          rc;</span><br><span class="line">    <span class="keyword">ngx_http_cache_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    r-&gt;cached = <span class="number">1</span>;</span><br><span class="line">    c = r-&gt;cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;header_start == c-&gt;body_start) &#123;</span><br><span class="line">        r-&gt;http_version = NGX_HTTP_VERSION_9;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_cache_send(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> cache stack */</span></span><br><span class="line"></span><br><span class="line">    u-&gt;buffer = *c-&gt;buf;</span><br><span class="line">    u-&gt;buffer.pos += c-&gt;header_start;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;u-&gt;headers_in, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_upstream_headers_in_t</span>));</span><br><span class="line">    u-&gt;headers_in.content_length_n = <span class="number">-1</span>;</span><br><span class="line">    u-&gt;headers_in.last_modified_time = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_list_init(&amp;u-&gt;headers_in.headers, r-&gt;pool, <span class="number">8</span>,</span><br><span class="line">                      <span class="keyword">sizeof</span>(<span class="keyword">ngx_table_elt_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_list_init(&amp;u-&gt;headers_in.trailers, r-&gt;pool, <span class="number">2</span>,</span><br><span class="line">                      <span class="keyword">sizeof</span>(<span class="keyword">ngx_table_elt_t</span>))</span><br><span class="line">        != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = u-&gt;process_header(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_upstream_process_headers(r, u) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ngx_http_cache_send(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">        rc = NGX_HTTP_UPSTREAM_INVALID_HEADER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_HTTP_UPSTREAM_INVALID_HEADER */</span></span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                  <span class="string">"cache file \"%s\" contains invalid header"</span>,</span><br><span class="line">                  c-&gt;file.name.data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> delete file */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-9-向上游回源"><a href="#2-9-向上游回源" class="headerlink" title="2.9 向上游回源"></a>2.9 向上游回源</h3><blockquote><p>若缓存不存在，nginx则向上游回源，那么整个流程就走到<em>ngx_http_upstream_init_request</em>函数的#if (NGX_HTTP_CACHE)块后，我们来看看其源码</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_upstream_init_request(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                      *host;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                      i;</span><br><span class="line">    <span class="keyword">ngx_resolver_ctx_t</span>             *ctx, temp;</span><br><span class="line">    <span class="keyword">ngx_http_cleanup_t</span>             *cln;</span><br><span class="line">    <span class="keyword">ngx_http_upstream_t</span>            *u;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>       *clcf;</span><br><span class="line">    <span class="keyword">ngx_http_upstream_srv_conf_t</span>   *uscf, **uscfp;</span><br><span class="line">    <span class="keyword">ngx_http_upstream_main_conf_t</span>  *umcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;aio) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u = r-&gt;upstream;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_CACHE)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;conf-&gt;cache) &#123;</span><br><span class="line">        <span class="keyword">ngx_int_t</span>  rc;</span><br><span class="line"></span><br><span class="line">        rc = ngx_http_upstream_cache(r, u);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_BUSY) &#123;</span><br><span class="line">            r-&gt;write_event_handler = ngx_http_upstream_init_request;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r-&gt;write_event_handler = ngx_http_request_empty_handler;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_ERROR) &#123;</span><br><span class="line">            ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">            rc = ngx_http_upstream_cache_send(r, u);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_DONE) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_HTTP_UPSTREAM_INVALID_HEADER) &#123;</span><br><span class="line">                rc = NGX_DECLINED;</span><br><span class="line">                r-&gt;cached = <span class="number">0</span>;</span><br><span class="line">                u-&gt;buffer.start = <span class="literal">NULL</span>;</span><br><span class="line">                u-&gt;cache_status = NGX_HTTP_CACHE_MISS;</span><br><span class="line">                u-&gt;request_sent = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_upstream_cache_background_update(r, u) != NGX_OK) &#123;</span><br><span class="line">                rc = NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc != NGX_DECLINED) &#123;</span><br><span class="line">            ngx_http_finalize_request(r, rc);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    u-&gt;store = u-&gt;conf-&gt;store;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *设置Nginx与下游客户端之间TCP连接的检查方法</span></span><br><span class="line"><span class="comment">    *实际上，这两个方法都会通过ngx_http_upstream_check_broken_connection方法检查Nginx与下游的连接是否正常，如果出现错误，就会立即终止连接。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!u-&gt;store &amp;&amp; !r-&gt;post_action &amp;&amp; !u-&gt;conf-&gt;ignore_client_abort) &#123;</span><br><span class="line">        <span class="comment">//注意这时候的r还是客户端的连接，与上游服务器的连接r还没有建立</span></span><br><span class="line">        r-&gt;read_event_handler = ngx_http_upstream_rd_check_broken_connection;</span><br><span class="line">        r-&gt;write_event_handler = ngx_http_upstream_wr_check_broken_connection;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//有接收到客户端包体，则把包体结构赋值给u-&gt;request_bufs，在后面的if (u-&gt;create_request(r) != NGX_OK) &#123;会用到</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;request_body) &#123;</span><br><span class="line">        u-&gt;request_bufs = r-&gt;request_body-&gt;bufs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;create_request(r) != NGX_OK) &#123; <span class="comment">//ngx_http_proxy_create_request</span></span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_upstream_set_local(r, u, u-&gt;conf-&gt;local) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;conf-&gt;socket_keepalive) &#123;</span><br><span class="line">        u-&gt;peer.so_keepalive = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">    <span class="comment">/* 初始化ngx_http_upstream_t结构中成员output向下游发送响应的方式 */</span></span><br><span class="line">    u-&gt;output.alignment = clcf-&gt;directio_alignment;</span><br><span class="line">    u-&gt;output.pool = r-&gt;pool;</span><br><span class="line">    u-&gt;output.bufs.num = <span class="number">1</span>;</span><br><span class="line">    u-&gt;output.bufs.size = clcf-&gt;client_body_buffer_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;output.output_filter == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        u-&gt;output.output_filter = ngx_chain_writer;</span><br><span class="line">        u-&gt;output.filter_ctx = &amp;u-&gt;writer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u-&gt;writer.pool = r-&gt;pool;</span><br><span class="line">    <span class="comment">/* 添加用于表示上游响应的状态，例如：错误编码、包体长度等 */</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;upstream_states == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        r-&gt;upstream_states = ngx_array_create(r-&gt;pool, <span class="number">1</span>,</span><br><span class="line">                                            <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_upstream_state_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;upstream_states == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        u-&gt;state = ngx_array_push(r-&gt;upstream_states);</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;state == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                               NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_memzero(u-&gt;state, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_upstream_state_t</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cln = ngx_http_cleanup_add(r, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (cln == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cln-&gt;handler = ngx_http_upstream_cleanup; <span class="comment">//当请求结束时，一定会调用ngx_http_upstream_cleanup方法</span></span><br><span class="line">    cln-&gt;data = r;</span><br><span class="line">    u-&gt;cleanup = &amp;cln-&gt;handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;resolved == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        uscf = u-&gt;conf-&gt;upstream;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> (NGX_HTTP_SSL)</span><br><span class="line">        u-&gt;ssl_name = u-&gt;resolved-&gt;host;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        host = &amp;u-&gt;resolved-&gt;host;</span><br><span class="line"></span><br><span class="line">        umcf = ngx_http_get_module_main_conf(r, ngx_http_upstream_module);</span><br><span class="line"></span><br><span class="line">        uscfp = umcf-&gt;upstreams.elts;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; umcf-&gt;upstreams.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">            uscf = uscfp[i];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (uscf-&gt;host.len == host-&gt;len</span><br><span class="line">                &amp;&amp; ((uscf-&gt;port == <span class="number">0</span> &amp;&amp; u-&gt;resolved-&gt;no_port)</span><br><span class="line">                     || uscf-&gt;port == u-&gt;resolved-&gt;port)</span><br><span class="line">                &amp;&amp; ngx_strncasecmp(uscf-&gt;host.data, host-&gt;data, host-&gt;len) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">goto</span> found;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (u-&gt;resolved-&gt;sockaddr) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (u-&gt;resolved-&gt;port == <span class="number">0</span></span><br><span class="line">                &amp;&amp; u-&gt;resolved-&gt;sockaddr-&gt;sa_family != AF_UNIX)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"no port in upstream \"%V\""</span>, host);</span><br><span class="line">                ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                               NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_upstream_create_round_robin_peer(r, u-&gt;resolved)</span><br><span class="line">                != NGX_OK)</span><br><span class="line">            &#123;</span><br><span class="line">                ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                               NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_http_upstream_connect(r, u);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (u-&gt;resolved-&gt;port == <span class="number">0</span>) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"no port in upstream \"%V\""</span>, host);</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                               NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        temp.name = *host;</span><br><span class="line">        <span class="comment">// 初始化域名解析器</span></span><br><span class="line">        ctx = ngx_resolve_start(clcf-&gt;resolver, &amp;temp);</span><br><span class="line">        <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                               NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx == NGX_NO_RESOLVER) &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                          <span class="string">"no resolver defined to resolve %V"</span>, host);</span><br><span class="line"></span><br><span class="line">            ngx_http_upstream_finalize_request(r, u, NGX_HTTP_BAD_GATEWAY);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx-&gt;name = *host;</span><br><span class="line">        ctx-&gt;handler = ngx_http_upstream_resolve_handler; <span class="comment">//设置域名解析完成后的回调函数。</span></span><br><span class="line">        ctx-&gt;data = r;</span><br><span class="line">        ctx-&gt;timeout = clcf-&gt;resolver_timeout;</span><br><span class="line"></span><br><span class="line">        u-&gt;resolved-&gt;ctx = ctx;</span><br><span class="line">        <span class="comment">//开始域名解析，没有完成也会返回的。</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_resolve_name(ctx) != NGX_OK) &#123;</span><br><span class="line">            u-&gt;resolved-&gt;ctx = <span class="literal">NULL</span>;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                               NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;  <span class="comment">// 域名还没有解析完成，则直接返回</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">found:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uscf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                      <span class="string">"no upstream configuration"</span>);</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                           NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u-&gt;upstream = uscf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_SSL)</span></span><br><span class="line">    u-&gt;ssl_name = uscf-&gt;host;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uscf-&gt;peer.init(r, uscf) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                           NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u-&gt;peer.start_time = ngx_current_msec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;conf-&gt;next_upstream_tries</span><br><span class="line">        &amp;&amp; u-&gt;peer.tries &gt; u-&gt;conf-&gt;next_upstream_tries)</span><br><span class="line">    &#123;</span><br><span class="line">        u-&gt;peer.tries = u-&gt;conf-&gt;next_upstream_tries;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_http_upstream_connect(r, u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-10-接受上游返回的数据"><a href="#2-10-接受上游返回的数据" class="headerlink" title="2.10 接受上游返回的数据"></a>2.10 接受上游返回的数据</h3><blockquote><p>该功能由<em>ngx_http_upstream_send_response</em>函数实现，我们来看看源码</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_upstream_send_response(<span class="keyword">ngx_http_request_t</span> *r, <span class="keyword">ngx_http_upstream_t</span> *u)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span>                    n;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>                  rc;</span><br><span class="line">    <span class="keyword">ngx_event_pipe_t</span>          *p;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>          *c;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    rc = ngx_http_send_header(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt; NGX_OK || r-&gt;post_action) &#123;</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u, rc);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u-&gt;header_sent = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;upgrade) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_CACHE)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;cache) &#123;</span><br><span class="line">            ngx_http_file_cache_free(r-&gt;cache, u-&gt;pipe-&gt;temp_file);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        ngx_http_upstream_upgrade(r, u);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_only) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!u-&gt;buffering) &#123;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u, rc);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!u-&gt;cacheable &amp;&amp; !u-&gt;store) &#123;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u, rc);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        u-&gt;pipe-&gt;downstream_error = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;request_body &amp;&amp; r-&gt;request_body-&gt;temp_file</span><br><span class="line">        &amp;&amp; r == r-&gt;main &amp;&amp; !r-&gt;preserve_body</span><br><span class="line">        &amp;&amp; !u-&gt;conf-&gt;preserve_output)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_pool_run_cleanup_file(r-&gt;pool, r-&gt;request_body-&gt;temp_file-&gt;file.fd);</span><br><span class="line">        r-&gt;request_body-&gt;temp_file-&gt;file.fd = NGX_INVALID_FILE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!u-&gt;buffering) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_CACHE)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;cache) &#123;</span><br><span class="line">            ngx_http_file_cache_free(r-&gt;cache, u-&gt;pipe-&gt;temp_file);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (u-&gt;input_filter == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            u-&gt;input_filter_init = ngx_http_upstream_non_buffered_filter_init;</span><br><span class="line">            u-&gt;input_filter = ngx_http_upstream_non_buffered_filter;</span><br><span class="line">            u-&gt;input_filter_ctx = r;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        u-&gt;read_event_handler = ngx_http_upstream_process_non_buffered_upstream;</span><br><span class="line">        r-&gt;write_event_handler =</span><br><span class="line">                             ngx_http_upstream_process_non_buffered_downstream;</span><br><span class="line"></span><br><span class="line">        r-&gt;limit_rate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (u-&gt;input_filter_init(u-&gt;input_filter_ctx) == NGX_ERROR) &#123;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clcf-&gt;tcp_nodelay &amp;&amp; ngx_tcp_nodelay(c) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n = u-&gt;buffer.last - u-&gt;buffer.pos;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n) &#123;</span><br><span class="line">            u-&gt;buffer.last = u-&gt;buffer.pos;</span><br><span class="line"></span><br><span class="line">            u-&gt;state-&gt;response_length += n;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (u-&gt;input_filter(u-&gt;input_filter_ctx, n) == NGX_ERROR) &#123;</span><br><span class="line">                ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_http_upstream_process_non_buffered_downstream(r);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            u-&gt;buffer.pos = u-&gt;buffer.start;</span><br><span class="line">            u-&gt;buffer.last = u-&gt;buffer.start;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_send_special(r, NGX_HTTP_FLUSH) == NGX_ERROR) &#123;</span><br><span class="line">                ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (u-&gt;peer.connection-&gt;read-&gt;ready || u-&gt;length == <span class="number">0</span>) &#123;</span><br><span class="line">                ngx_http_upstream_process_non_buffered_upstream(r, u);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> preallocate event_pipe bufs, look "Content-Length" */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_CACHE)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;cache &amp;&amp; r-&gt;cache-&gt;file.fd != NGX_INVALID_FILE) &#123;</span><br><span class="line">        ngx_pool_run_cleanup_file(r-&gt;pool, r-&gt;cache-&gt;file.fd);</span><br><span class="line">        r-&gt;cache-&gt;file.fd = NGX_INVALID_FILE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (ngx_http_test_predicates(r, u-&gt;conf-&gt;no_cache)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_ERROR:</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_DECLINED:</span><br><span class="line">        u-&gt;cacheable = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>: <span class="comment">/* NGX_OK */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (u-&gt;cache_status == NGX_HTTP_CACHE_BYPASS) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* create cache if previously bypassed */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_file_cache_create(r) != NGX_OK) &#123;</span><br><span class="line">                ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;cacheable) &#123;</span><br><span class="line">        <span class="keyword">time_t</span>  now, valid;</span><br><span class="line"></span><br><span class="line">        now = ngx_time();</span><br><span class="line"></span><br><span class="line">        valid = r-&gt;cache-&gt;valid_sec;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valid == <span class="number">0</span>) &#123;</span><br><span class="line">            valid = ngx_http_file_cache_valid(u-&gt;conf-&gt;cache_valid,</span><br><span class="line">                                              u-&gt;headers_in.status_n);</span><br><span class="line">            <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">                r-&gt;cache-&gt;valid_sec = now + valid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有配置proxy_cache_valid，valid的值为0</span></span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">            r-&gt;cache-&gt;date = now;</span><br><span class="line">            r-&gt;cache-&gt;body_start = (u_short) (u-&gt;buffer.pos - u-&gt;buffer.start);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (u-&gt;headers_in.status_n == NGX_HTTP_OK</span><br><span class="line">                || u-&gt;headers_in.status_n == NGX_HTTP_PARTIAL_CONTENT)</span><br><span class="line">            &#123;</span><br><span class="line">                r-&gt;cache-&gt;last_modified = u-&gt;headers_in.last_modified_time;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (u-&gt;headers_in.etag) &#123;</span><br><span class="line">                    r-&gt;cache-&gt;etag = u-&gt;headers_in.etag-&gt;value;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ngx_str_null(&amp;r-&gt;cache-&gt;etag);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r-&gt;cache-&gt;last_modified = <span class="number">-1</span>;</span><br><span class="line">                ngx_str_null(&amp;r-&gt;cache-&gt;etag);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_http_file_cache_set_header(r, u-&gt;buffer.start) != NGX_OK) &#123;</span><br><span class="line">                ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            u-&gt;cacheable = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http cacheable: %d"</span>, u-&gt;cacheable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;cacheable == <span class="number">0</span> &amp;&amp; r-&gt;cache) &#123;</span><br><span class="line">        ngx_http_file_cache_free(r-&gt;cache, u-&gt;pipe-&gt;temp_file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_only &amp;&amp; !u-&gt;cacheable &amp;&amp; !u-&gt;store) &#123;</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    p = u-&gt;pipe;</span><br><span class="line"></span><br><span class="line">    p-&gt;output_filter = ngx_http_upstream_output_filter;</span><br><span class="line">    p-&gt;output_ctx = r;</span><br><span class="line">    p-&gt;tag = u-&gt;output.tag;</span><br><span class="line">    p-&gt;bufs = u-&gt;conf-&gt;bufs;</span><br><span class="line">    p-&gt;busy_size = u-&gt;conf-&gt;busy_buffers_size;</span><br><span class="line">    p-&gt;upstream = u-&gt;peer.connection;</span><br><span class="line">    p-&gt;downstream = c;</span><br><span class="line">    p-&gt;pool = r-&gt;pool;</span><br><span class="line">    p-&gt;<span class="built_in">log</span> = c-&gt;<span class="built_in">log</span>;</span><br><span class="line">    p-&gt;limit_rate = u-&gt;conf-&gt;limit_rate;</span><br><span class="line">    p-&gt;start_sec = ngx_time();</span><br><span class="line"></span><br><span class="line">    p-&gt;cacheable = u-&gt;cacheable || u-&gt;store;</span><br><span class="line"></span><br><span class="line">    p-&gt;temp_file = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_temp_file_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;temp_file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p-&gt;temp_file-&gt;file.fd = NGX_INVALID_FILE;</span><br><span class="line">    p-&gt;temp_file-&gt;file.<span class="built_in">log</span> = c-&gt;<span class="built_in">log</span>;</span><br><span class="line">    p-&gt;temp_file-&gt;path = u-&gt;conf-&gt;temp_path; <span class="comment">//u-&gt;conf-&gt;temp_path的值在ngx_http_proxy_handler函数中赋值，赋值流程为ngx_http_proxy_merge_loc_conf-&gt;ngx_conf_merge_path_value</span></span><br><span class="line">    p-&gt;temp_file-&gt;pool = r-&gt;pool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p-&gt;cacheable) &#123;</span><br><span class="line">        p-&gt;temp_file-&gt;persistent = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_CACHE)</span></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;cache &amp;&amp; !r-&gt;cache-&gt;file_cache-&gt;use_temp_path) &#123;</span><br><span class="line">            p-&gt;temp_file-&gt;path = r-&gt;cache-&gt;file_cache-&gt;path;</span><br><span class="line">            p-&gt;temp_file-&gt;file.name = r-&gt;cache-&gt;file.name;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p-&gt;temp_file-&gt;log_level = NGX_LOG_WARN;</span><br><span class="line">        p-&gt;temp_file-&gt;warn = <span class="string">"an upstream response is buffered "</span></span><br><span class="line">                             <span class="string">"to a temporary file"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p-&gt;max_temp_file_size = u-&gt;conf-&gt;max_temp_file_size;</span><br><span class="line">    p-&gt;temp_file_write_size = u-&gt;conf-&gt;temp_file_write_size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_THREADS)</span></span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;aio == NGX_HTTP_AIO_THREADS &amp;&amp; clcf-&gt;aio_write) &#123;</span><br><span class="line">        p-&gt;thread_handler = ngx_http_upstream_thread_handler;</span><br><span class="line">        p-&gt;thread_ctx = r;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    p-&gt;preread_bufs = ngx_alloc_chain_link(r-&gt;pool);</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;preread_bufs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p-&gt;preread_bufs-&gt;buf = &amp;u-&gt;buffer;</span><br><span class="line">    p-&gt;preread_bufs-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    u-&gt;buffer.recycled = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    p-&gt;preread_size = u-&gt;buffer.last - u-&gt;buffer.pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;cacheable) &#123;</span><br><span class="line"></span><br><span class="line">        p-&gt;buf_to_file = ngx_calloc_buf(r-&gt;pool);</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;buf_to_file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p-&gt;buf_to_file-&gt;start = u-&gt;buffer.start;</span><br><span class="line">        p-&gt;buf_to_file-&gt;pos = u-&gt;buffer.start;</span><br><span class="line">        p-&gt;buf_to_file-&gt;last = u-&gt;buffer.pos;</span><br><span class="line">        p-&gt;buf_to_file-&gt;temporary = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_IOCP_EVENT) &#123;</span><br><span class="line">        <span class="comment">/* the posted aio operation may corrupt a shadow buffer */</span></span><br><span class="line">        p-&gt;single_buf = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> p-&gt;free_bufs = 0 if use ngx_create_chain_of_bufs() */</span></span><br><span class="line">    p-&gt;free_bufs = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * event_pipe would do u-&gt;buffer.last += p-&gt;preread_size</span></span><br><span class="line"><span class="comment">     * as though these bytes were read</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    u-&gt;buffer.last = u-&gt;buffer.pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;conf-&gt;cyclic_temp_file) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * we need to disable the use of sendfile() if we use cyclic temp file</span></span><br><span class="line"><span class="comment">         * because the writing a new data may interfere with sendfile()</span></span><br><span class="line"><span class="comment">         * that uses the same kernel file pages (at least on FreeBSD)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        p-&gt;cyclic_temp_file = <span class="number">1</span>;</span><br><span class="line">        c-&gt;sendfile = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p-&gt;cyclic_temp_file = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p-&gt;read_timeout = u-&gt;conf-&gt;read_timeout;</span><br><span class="line">    p-&gt;send_timeout = clcf-&gt;send_timeout;</span><br><span class="line">    p-&gt;send_lowat = clcf-&gt;send_lowat;</span><br><span class="line"></span><br><span class="line">    p-&gt;length = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;input_filter_init</span><br><span class="line">        &amp;&amp; u-&gt;input_filter_init(p-&gt;input_ctx) != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u-&gt;read_event_handler = ngx_http_upstream_process_upstream;</span><br><span class="line">    r-&gt;write_event_handler = ngx_http_upstream_process_downstream;</span><br><span class="line"></span><br><span class="line">    ngx_http_upstream_process_upstream(r, u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>读取数据的具体操作在<em>ngx_http_upstream_process_upstream</em>函数中实现</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">ngx_http_upstream_process_upstream(<span class="keyword">ngx_http_request_t</span> *r,</span><br><span class="line">    <span class="keyword">ngx_http_upstream_t</span> *u)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>       *rev;</span><br><span class="line">    <span class="keyword">ngx_event_pipe_t</span>  *p;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    c = u-&gt;peer.connection;</span><br><span class="line">    p = u-&gt;pipe;</span><br><span class="line">    rev = c-&gt;read;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"http upstream process upstream"</span>);</span><br><span class="line"></span><br><span class="line">    c-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"reading upstream"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timedout) &#123;</span><br><span class="line"></span><br><span class="line">        p-&gt;upstream_error = <span class="number">1</span>;</span><br><span class="line">        ngx_connection_error(c, NGX_ETIMEDOUT, <span class="string">"upstream timed out"</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">//请求没有超时，那么对后端，处理一下读事件。ngx_event_pipe开始处理</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rev-&gt;delayed) &#123;</span><br><span class="line"></span><br><span class="line">            ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">"http upstream delayed"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_handle_read_event(rev, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">                ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_event_pipe(p, <span class="number">0</span>) == NGX_ABORT) &#123;</span><br><span class="line">            ngx_http_upstream_finalize_request(r, u, NGX_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//注意走到这里的时候，后端发送的头部行信息已经在前面的ngx_http_upstream_send_response-&gt;ngx_http_send_header已经把头部行部分发送给客户端了</span></span><br><span class="line">    <span class="comment">//该函数处理的只是后端放回过来的网页包体部分</span></span><br><span class="line">    ngx_http_upstream_process_request(r, u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>接下来分析一下<em>ngx_event_pipe</em>这个函数，在有buffering的时候，使用event_pipe进行数据的转发，调用ngx_event_pipe_write_to_downstream函数读取数据，或者发送数据给客户端。<br>ngx_event_pipe将upstream响应发送回客户端。do_write代表是否要往客户端发送，写数据。如果设置了，那么会先发给客户端，再读upstream数据，当然，如果读取了数据，也会调用这里的。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_event_pipe(<span class="keyword">ngx_event_pipe_t</span> *p, <span class="keyword">ngx_int_t</span> do_write)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>     rc;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>    flags;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>  *rev, *wev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (do_write) &#123;</span><br><span class="line">            p-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"sending to client"</span>;</span><br><span class="line"></span><br><span class="line">            rc = ngx_event_pipe_write_to_downstream(p);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_ABORT) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ABORT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_BUSY) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_OK;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p-&gt;read = <span class="number">0</span>;</span><br><span class="line">        p-&gt;upstream_blocked = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        p-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">"reading upstream"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_event_pipe_read_upstream(p) == NGX_ABORT) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ABORT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!p-&gt;read &amp;&amp; !p-&gt;upstream_blocked) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        do_write = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p-&gt;upstream-&gt;fd != (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">        rev = p-&gt;upstream-&gt;read;</span><br><span class="line"></span><br><span class="line">        flags = (rev-&gt;eof || rev-&gt;error) ? NGX_CLOSE_EVENT : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_read_event(rev, flags) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ABORT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!rev-&gt;delayed) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rev-&gt;active &amp;&amp; !rev-&gt;ready) &#123;</span><br><span class="line">                ngx_add_timer(rev, p-&gt;read_timeout);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rev-&gt;timer_set) &#123;</span><br><span class="line">                ngx_del_timer(rev);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p-&gt;downstream-&gt;fd != (<span class="keyword">ngx_socket_t</span>) <span class="number">-1</span></span><br><span class="line">        &amp;&amp; p-&gt;downstream-&gt;data == p-&gt;output_ctx)</span><br><span class="line">    &#123;</span><br><span class="line">        wev = p-&gt;downstream-&gt;write;</span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_write_event(wev, p-&gt;send_lowat) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ABORT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!wev-&gt;delayed) &#123;</span><br><span class="line">            <span class="keyword">if</span> (wev-&gt;active &amp;&amp; !wev-&gt;ready) &#123;</span><br><span class="line">                ngx_add_timer(wev, p-&gt;send_timeout);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wev-&gt;timer_set) &#123;</span><br><span class="line">                ngx_del_timer(wev);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个函数中最重要的就是ngx_event_pipe_write_to_downstream跟ngx_event_pipe_read_upstream，这两个函数将处理来自上游的数据以及将数据转发到客户端。</p></blockquote></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://weeweetan.github.io/2019/06/27/Nginx缓存详解/" title="Nginx缓存详解" target="_blank" rel="external">https://weeweetan.github.io/2019/06/27/Nginx缓存详解/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/weeweetan" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/weeweetan" target="_blank"><span class="text-dark">weeweetan</span><small class="ml-1x">Backend Developer</small></a></h3><div>初级程序猿，之前主要涉及数据备份相关领域，现在研究CDN方向。业余时间也喜欢锻炼下，目前参过一次半程马拉松，四次全程马拉松，半马最好成绩99分钟，全马最好成绩3小时47分钟。</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2019/07/16/Nginx的upstream模块/" title="Nginx的upstream模块"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2019/06/17/Nginx反向代理详解/" title="Nginx反向代理详解"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.jpg" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.jpg" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/weeweetan" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.com" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright">&copy; 2021 weeweetan<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script><script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"d1c2d759e243e33eff9f",clientSecret:"8bf8ce0f7198ac71bde522fc93877107874d7da1",repo:"weeweetan.github.io",owner:"weeweetan",admin:["weeweetan"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("comments")</script></body></html><!-- rebuild by neat -->